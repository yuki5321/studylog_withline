<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†ä¸­ãƒ­ã‚° - æ­¦å†…AI æœ€å¼·å®‰å®šç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-primary: #f4f7f6;
            --bg-secondary: white;
            --bg-accent: #fff3cd;
            --text-primary: #333;
            --text-secondary: #666;
            --text-accent: #00b900;
            --border-color: #ddd;
            --shadow-color: rgba(0,0,0,0.05);
            --btn-bg: #f9f9f9;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-accent: #3d3d1a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-accent: #00ff00;
            --border-color: #444;
            --shadow-color: rgba(0,0,0,0.3);
            --btn-bg: #3a3a3a;
        }
        
        body { 
            font-family: sans-serif; 
            text-align: center; 
            padding: 20px; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        h2 { margin-bottom: 5px; color: var(--text-accent); }
        #user-name { font-size: 0.8rem; margin-bottom: 10px; color: var(--text-secondary); }
        #theme-toggle { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: var(--bg-secondary); 
            border: 2px solid var(--border-color); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            cursor: pointer; 
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        #theme-toggle:hover { transform: scale(1.1); }
        #exam-countdown-area { 
            display:none; 
            background: var(--bg-accent); 
            padding: 12px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border-color);
        }
        #days-left { font-size: 1.8rem; color: #d9534f; font-weight: bold; }
        #history-area { 
            background: var(--bg-secondary); 
            padding: 12px; 
            border-radius: 12px; 
            box-shadow: 0 2px 4px var(--shadow-color); 
            margin-bottom: 15px; 
        }
        #total-time { font-size: 1.6rem; font-weight: bold; color: var(--text-accent); }
        .timer { font-size: 3.5rem; font-weight: bold; margin: 15px 0; font-family: monospace; }
        .subjects { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .subject-btn { 
            padding: 8px 5px; 
            border: 2px solid var(--border-color); 
            border-radius: 10px; 
            background: var(--bg-secondary); 
            color: var(--text-primary);
            font-size: 0.7rem; 
            height: 65px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            line-height: 1.2;
            transition: all 0.2s;
            cursor: pointer;
        }
        .subject-btn:hover { transform: scale(1.05); }
        .subject-btn.active { background: #00b900; color: white; border-color: #00b900; font-weight: bold; }
        
        /* ç§‘ç›®åˆ¥ã‚«ãƒ©ãƒ¼ */
        .subject-btn[data-subject*="å›½èª"] { border-color: #ff6b9d; }
        .subject-btn[data-subject*="è¨€èªæ–‡åŒ–"] { border-color: #ff8fa3; }
        .subject-btn[data-subject*="æ•°å­¦"] { border-color: #4a90e2; }
        .subject-btn[data-subject*="è«–ç†è¡¨ç¾"] { border-color: #6bcf7f; }
        .subject-btn[data-subject*="EC"] { border-color: #52c78a; }
        .subject-btn[data-subject*="ç‰©ç†"] { border-color: #9b59b6; }
        .subject-btn[data-subject*="åŒ–å­¦"] { border-color: #e67e22; }
        .subject-btn[data-subject*="ç”Ÿç‰©"] { border-color: #27ae60; }
        .subject-btn[data-subject*="æ­´å²"] { border-color: #d4990d; }
        .subject-btn[data-subject*="èŠ¸è¡“"] { border-color: #e91e63; }
        .subject-btn[data-subject*="ä¿å¥"] { border-color: #00bcd4; }
        .subject-btn[data-subject*="æƒ…å ±"] { border-color: #607d8b; }
        
        .subject-icon { font-size: 1.2rem; margin-bottom: 2px; }
        .target-score { font-size: 0.6rem; color: #ff4b4b; margin-top: 4px; font-weight: bold; }
        .subject-btn.active .target-score { color: #fff; }
        #main-btn { width: 100%; padding: 18px; font-size: 1.3rem; border: none; border-radius: 50px; color: white; background: #00b900; font-weight: bold; }
        #main-btn.stop { background: #ff4b4b; }
        #feedback-area { 
            background: var(--bg-secondary); 
            padding: 20px; 
            border-radius: 20px; 
            display:none; 
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        #exam-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; overflow-y: auto; }
        .modal-content { 
            background: var(--bg-secondary); 
            margin:5% 5%; 
            padding:20px; 
            border-radius:20px; 
            text-align:left;
        }
        .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .score-grid div { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: var(--btn-bg); 
            padding: 8px; 
            border-radius: 8px; 
            font-size: 0.8rem; 
        }
        .score-grid input { 
            width: 45px; 
            padding: 5px; 
            text-align: center; 
            border: 1px solid var(--border-color); 
            border-radius: 5px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        #status-indicator { color: var(--text-accent); font-weight: bold; margin-top: 10px; }
        #goal-setting { margin-bottom:15px; }
        #goal-input {
            width:50px; 
            text-align:center;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <button id="theme-toggle" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
    <h2>å­¦ç¿’è¨˜éŒ²</h2>
    <div id="user-name">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="exam-countdown-area">
        <span style="font-weight:bold;">å­¦å¹´æœ«è€ƒæŸ»</span> ã¾ã§ ã‚ã¨ <span id="days-left">--</span> æ—¥
        <div id="exam-msg" style="font-size:0.75rem; color:#666; margin-top:5px;"></div>
    </div>

    <div id="history-area">
        <div style="font-size: 0.7rem;">ç´¯è¨ˆå­¦ç¿’æ™‚é–“</div>
        <div><span id="total-time">0</span> åˆ†</div>
    </div>

    <button onclick="openExamModal()" style="font-size: 0.75rem; margin-bottom: 15px; color: #00b900; background: none; border: none; text-decoration: underline;">ç›®æ¨™ç‚¹æ•°ã‚’å…¥åŠ›ã™ã‚‹</button>

    <div class="timer" id="timer-display">00:00</div>

    <div id="subject-selector-ui">
        <div class="subjects">
            <div class="subject-btn active" data-subject="ç¾ä»£ã®å›½èª" onclick="selectSubject('ç¾ä»£ã®å›½èª')">
                <span class="subject-icon">ğŸ“–</span>ç¾ä»£ã®å›½èª<span class="target-score" id="target-ç¾ä»£ã®å›½èª"></span>
            </div>
            <div class="subject-btn" data-subject="è¨€èªæ–‡åŒ–" onclick="selectSubject('è¨€èªæ–‡åŒ–')">
                <span class="subject-icon">ğŸŒ¸</span>è¨€èªæ–‡åŒ–<span class="target-score" id="target-è¨€èªæ–‡åŒ–"></span>
            </div>
            <div class="subject-btn" data-subject="æ•°å­¦â… " onclick="selectSubject('æ•°å­¦â… ')">
                <span class="subject-icon">ğŸ“Š</span>æ•°å­¦â… <span class="target-score" id="target-æ•°å­¦â… "></span>
            </div>
            <div class="subject-btn" data-subject="æ•°å­¦A" onclick="selectSubject('æ•°å­¦A')">
                <span class="subject-icon">ğŸ”¢</span>æ•°å­¦A<span class="target-score" id="target-æ•°å­¦A"></span>
            </div>
            <div class="subject-btn" data-subject="è«–ç†è¡¨ç¾â… " onclick="selectSubject('è«–ç†è¡¨ç¾â… ')">
                <span class="subject-icon">ğŸ’¬</span>è«–ç†è¡¨ç¾â… <span class="target-score" id="target-è«–ç†è¡¨ç¾â… "></span>
            </div>
            <div class="subject-btn" data-subject="ECâ… " onclick="selectSubject('ECâ… ')">
                <span class="subject-icon">ğŸŒ</span>ECâ… <span class="target-score" id="target-ECâ… "></span>
            </div>
            <div class="subject-btn" data-subject="ç‰©ç†åŸºç¤" onclick="selectSubject('ç‰©ç†åŸºç¤')">
                <span class="subject-icon">âš›ï¸</span>ç‰©ç†åŸºç¤<span class="target-score" id="target-ç‰©ç†åŸºç¤"></span>
            </div>
            <div class="subject-btn" data-subject="åŒ–å­¦åŸºç¤" onclick="selectSubject('åŒ–å­¦åŸºç¤')">
                <span class="subject-icon">ğŸ§ª</span>åŒ–å­¦åŸºç¤<span class="target-score" id="target-åŒ–å­¦åŸºç¤"></span>
            </div>
            <div class="subject-btn" data-subject="ç”Ÿç‰©åŸºç¤" onclick="selectSubject('ç”Ÿç‰©åŸºç¤')">
                <span class="subject-icon">ğŸŒ±</span>ç”Ÿç‰©åŸºç¤<span class="target-score" id="target-ç”Ÿç‰©åŸºç¤"></span>
            </div>
            <div class="subject-btn" data-subject="æ­´å²ç·åˆ" onclick="selectSubject('æ­´å²ç·åˆ')">
                <span class="subject-icon">ğŸ›ï¸</span>æ­´å²ç·åˆ<span class="target-score" id="target-æ­´å²ç·åˆ"></span>
            </div>
            <div class="subject-btn" data-subject="èŠ¸è¡“" onclick="selectSubject('èŠ¸è¡“')">
                <span class="subject-icon">ğŸ¨</span>èŠ¸è¡“<span class="target-score" id="target-èŠ¸è¡“"></span>
            </div>
            <div class="subject-btn" data-subject="ä¿å¥" onclick="selectSubject('ä¿å¥')">
                <span class="subject-icon">ğŸ’š</span>ä¿å¥<span class="target-score" id="target-ä¿å¥"></span>
            </div>
            <div class="subject-btn" data-subject="ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… " onclick="selectSubject('ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… ')">
                <span class="subject-icon">ğŸ’»</span>ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… <span class="target-score" id="target-ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… "></span>
            </div>
        </div>
    </div>

    <div id="goal-setting" style="margin-bottom:15px;">
        <span style="font-size: 0.8rem;">ä»Šå›ã®ç›®æ¨™(åˆ†): </span>
        <input type="number" id="goal-input" value="0" min="0" style="width:50px; text-align:center;">
    </div>

    <div id="feedback-area">
        <p style="font-weight: bold;">é›†ä¸­ã§ããŸï¼Ÿ</p>
        <div class="subjects">
            <div class="subject-btn" onclick="finishWithScore('ğŸ¤©', 3)">ğŸ¤© å®Œç’§</div>
            <div class="subject-btn" onclick="finishWithScore('ğŸ˜', 2)">ğŸ˜ æ™®é€š</div>
            <div class="subject-btn" onclick="finishWithScore('ğŸ˜´', 1)">ğŸ˜´ çœ ã„</div>
        </div>
        <div id="status-indicator"></div>
    </div>

    <button id="main-btn" onclick="toggleTimer()">START</button>

    <div id="exam-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#00b900;">å­¦å¹´æœ«è€ƒæŸ» ç›®æ¨™è¨­å®š</h3>
            <div class="score-grid">
                <div><span>ç¾å›½</span><input type="number" class="score-in" data-sub="ç¾ä»£ã®å›½èª"></div>
                <div><span>è¨€æ–‡</span><input type="number" class="score-in" data-sub="è¨€èªæ–‡åŒ–"></div>
                <div><span>æ•°â… </span><input type="number" class="score-in" data-sub="æ•°å­¦â… "></div>
                <div><span>æ•°A</span><input type="number" class="score-in" data-sub="æ•°å­¦A"></div>
                <div><span>è«–ç†</span><input type="number" class="score-in" data-sub="è«–ç†è¡¨ç¾â… "></div>
                <div><span>ECâ… </span><input type="number" class="score-in" data-sub="ECâ… "></div>
                <div><span>ç‰©ç†</span><input type="number" class="score-in" data-sub="ç‰©ç†åŸºç¤"></div>
                <div><span>åŒ–å­¦</span><input type="number" class="score-in" data-sub="åŒ–å­¦åŸºç¤"></div>
                <div><span>ç”Ÿç‰©</span><input type="number" class="score-in" data-sub="ç”Ÿç‰©åŸºç¤"></div>
                <div><span>æ­´å²</span><input type="number" class="score-in" data-sub="æ­´å²ç·åˆ"></div>
                <div><span>èŠ¸è¡“</span><input type="number" class="score-in" data-sub="èŠ¸è¡“"></div>
                <div><span>ä¿å¥</span><input type="number" class="score-in" data-sub="ä¿å¥"></div>
                <div style="grid-column: span 2;"><span>ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… </span><input type="number" class="score-in" data-sub="ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… "></div>
            </div>
            <textarea id="exam-msg-input" rows="2" placeholder="æ„æ°—è¾¼ã¿ã‚’å…¥åŠ›ï¼" style="width:100%; border-radius:8px; border:1px solid #ddd;"></textarea>
            <button onclick="saveExamGoal()" style="width:100%; padding:15px; background:#00b900; color:white; border:none; border-radius:12px; font-weight:bold; margin-top:10px;">ç›®æ¨™ã‚’ç¢ºå®šã™ã‚‹</button>
            <button onclick="closeExamModal()" style="width:100%; margin-top:10px; background:none; border:none; color:#999;">æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        let startTime, timerInterval, goalSeconds;
        let isRunning = false, isCountdown = false, finalDuration = 0;
        let selectedSubject = 'ç¾ä»£ã®å›½èª', displayName = "Unknown";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx0lGxxv5qfnCe0zTuoqYSE-Pat2dY8Bne8O_1SQ1Neie6kVoTqHoBXBuorVg1ZakM/exec";

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.getElementById('theme-toggle').innerText = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('theme', newTheme);
        }

        // ãƒ†ãƒ¼ãƒã®åˆæœŸåŒ–
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').innerText = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        async function initLiff() {
            try {
                await liff.init({ liffId: "2009056355-TruGatly" }); 
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    displayName = profile.displayName; 
                    document.getElementById('user-name').innerText = `ã“ã‚“ã«ã¡ã¯ã€${displayName}ã•ã‚“`;
                    await loadHistory();
                    await loadExamCountdown();
                    checkResumeTimer();
                    await checkPendingRecords(); // æœªé€ä¿¡è¨˜éŒ²ã®ãƒã‚§ãƒƒã‚¯
                }
            } catch (err) { console.error(err); }
        }

        // æœªé€ä¿¡è¨˜éŒ²ã®ãƒã‚§ãƒƒã‚¯ã¨å†é€
        async function checkPendingRecords() {
            const pending = localStorage.getItem('pendingRecords');
            if (!pending) return;

            const records = JSON.parse(pending);
            if (records.length === 0) return;

            const confirm = window.confirm(`æœªé€ä¿¡ã®å­¦ç¿’è¨˜éŒ²ãŒ${records.length}ä»¶ã‚ã‚Šã¾ã™ã€‚\né€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`);
            if (!confirm) return;

            const indicator = document.getElementById('user-name');
            const originalText = indicator.innerText;
            indicator.innerText = 'æœªé€ä¿¡è¨˜éŒ²ã‚’é€ä¿¡ä¸­...';

            let successCount = 0;
            const failedRecords = [];

            for (const record of records) {
                try {
                    const r = await fetch(GAS_URL, { 
                        method: 'POST', 
                        body: JSON.stringify(record),
                        signal: AbortSignal.timeout(10000)
                    });
                    const res = await r.json();
                    if (res.status === 'success') {
                        successCount++;
                    } else {
                        failedRecords.push(record);
                    }
                } catch (e) {
                    console.error('å†é€å¤±æ•—:', e);
                    failedRecords.push(record);
                }
            }

            // å¤±æ•—ã—ãŸè¨˜éŒ²ã®ã¿ä¿æŒ
            if (failedRecords.length > 0) {
                localStorage.setItem('pendingRecords', JSON.stringify(failedRecords));
                alert(`${successCount}ä»¶é€ä¿¡å®Œäº†ã€‚${failedRecords.length}ä»¶ã¯å†é€å¤±æ•—ã—ã¾ã—ãŸã€‚`);
            } else {
                localStorage.removeItem('pendingRecords');
                alert(`${successCount}ä»¶ã™ã¹ã¦é€ä¿¡å®Œäº†ã—ã¾ã—ãŸï¼`);
            }

            indicator.innerText = originalText;
            await loadHistory(); // å±¥æ­´ã‚’æ›´æ–°
        }

        function checkResumeTimer() {
            const savedStart = localStorage.getItem('study_startTime');
            if (savedStart) {
                startTime = parseInt(savedStart);
                const savedGoal = localStorage.getItem('study_goalMin');
                const savedSub = localStorage.getItem('study_subject');
                if (savedSub) selectSubject(savedSub);
                document.getElementById('goal-input').value = savedGoal || 0;
                isCountdown = (parseInt(savedGoal) || 0) > 0;
                goalSeconds = (parseInt(savedGoal) || 0) * 60;
                isRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                const btn = document.getElementById('main-btn');
                btn.innerText = 'STOP'; btn.classList.add('stop');
                document.getElementById('goal-setting').style.display = 'none';
            }
        }

        async function loadHistory() {
            try {
                const r = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getHistory', userName: displayName }) });
                const res = await r.json();
                if (res.status === "success") {
                    document.getElementById('total-time').innerText = res.totalMinutes;
                    if (res.scores) {
                        for (let sub in res.scores) {
                            const el = document.getElementById('target-' + sub);
                            if (el && res.scores[sub]) el.innerText = res.scores[sub] + "ç‚¹ç›®æ¨™";
                        }
                    }
                }
            } catch(e) { console.error(e); }
        }

        async function loadExamCountdown() {
            try {
                const r = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getLatestExam', userName: displayName }) });
                const res = await r.json();
                const testDate = new Date("2026-03-02T00:00:00");
                const diffDays = Math.ceil((testDate - new Date().setHours(0,0,0,0)) / (86400000));
                if (diffDays >= 0) {
                    document.getElementById('exam-countdown-area').style.display = 'block';
                    document.getElementById('days-left').innerText = diffDays;
                    if (res.status === "success" && res.goal) document.getElementById('exam-msg').innerText = "ã€Œ" + res.goal.message + "ã€";
                }
            } catch(e) { console.error(e); }
        }

        function openExamModal() { document.getElementById('exam-modal').style.display = 'block'; }
        function closeExamModal() { document.getElementById('exam-modal').style.display = 'none'; }

        async function saveExamGoal() {
            const scores = {};
            document.querySelectorAll('.score-in').forEach(el => { scores[el.dataset.sub] = el.value || 0; });
            const msg = document.getElementById('exam-msg-input').value;
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'saveExamGoal', userName: displayName, scores: scores, message: msg }) });
            alert("ç›®æ¨™è¨­å®šå®Œäº†ï¼"); closeExamModal(); loadHistory(); loadExamCountdown();
        }

        function selectSubject(s) { 
            if (!isRunning) { 
                selectedSubject = s; 
                document.querySelectorAll('.subject-btn').forEach(b => {
                    const isActive = b.getAttribute('data-subject') === s;
                    b.classList.toggle('active', isActive);
                });
            } 
        }

        function toggleTimer() {
            const btn = document.getElementById('main-btn');
            if (!isRunning) {
                const gMin = parseInt(document.getElementById('goal-input').value) || 0;
                isCountdown = gMin > 0; goalSeconds = gMin * 60;
                startTime = Date.now(); 
                localStorage.setItem('study_startTime', startTime);
                localStorage.setItem('study_goalMin', gMin);
                localStorage.setItem('study_subject', selectedSubject);
                timerInterval = setInterval(updateTimer, 1000);
                btn.innerText = 'STOP'; btn.classList.add('stop'); isRunning = true;
                document.getElementById('goal-setting').style.display = 'none';
            } else { stopTimer(); }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            let dSec = isCountdown ? Math.max(0, goalSeconds - elapsed) : elapsed;
            document.getElementById('timer-display').innerText = `${String(Math.floor(dSec / 60)).padStart(2, '0')}:${String(dSec % 60).padStart(2, '0')}`;
            if (isCountdown && dSec === 0) stopTimer();
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const actual = Math.floor((Date.now() - startTime) / 1000);
            finalDuration = isCountdown ? Math.min(actual, goalSeconds) : actual;
            
            // é”æˆæ„Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç´™å¹é›ªï¼‰
            celebrateCompletion(finalDuration);
            
            document.getElementById('main-btn').style.display = 'none';
            document.getElementById('subject-selector-ui').style.display = 'none';
            document.getElementById('feedback-area').style.display = 'block';
            isRunning = false;
        }

        // é”æˆæ„Ÿæ¼”å‡º
        function celebrateCompletion(duration) {
            const minutes = Math.ceil(duration / 60);
            
            // 5åˆ†æœªæº€ã¯æ§ãˆã‚
            if (minutes < 5) return;
            
            // åŸºæœ¬ã®ç´™å¹é›ª
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            // 10åˆ†ä»¥ä¸Šã§ã•ã‚‰ã«æ´¾æ‰‹ã«
            if (minutes >= 10) {
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 }
                    });
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 }
                    });
                }, 200);
            }
            
            // 30åˆ†ä»¥ä¸Šã§é€£ç¶šèŠ±ç«
            if (minutes >= 30) {
                let count = 0;
                const interval = setInterval(() => {
                    confetti({
                        particleCount: 30,
                        startVelocity: 30,
                        spread: 360,
                        origin: {
                            x: Math.random(),
                            y: Math.random() - 0.2
                        }
                    });
                    count++;
                    if (count >= 3) clearInterval(interval);
                }, 300);
            }
        }

        async function finishWithScore(emoji, score) {
            const min = Math.max(1, Math.ceil(finalDuration / 60));
            if (min < 5) { alert("5åˆ†ä»¥ä¸Šã®å­¦ç¿’ã®ã¿è¨˜éŒ²ã§ãã¾ã™ã€‚ã‚ã¨å°‘ã—é ‘å¼µã‚ã†ï¼ğŸ”¥"); location.reload(); return; }

            // UIã®ãƒ­ãƒƒã‚¯
            const allBtns = document.querySelectorAll('button, .subject-btn');
            allBtns.forEach(b => b.style.pointerEvents = 'none');
            const indicator = document.getElementById('status-indicator');
            indicator.innerText = "æ­¦å†…AIã«é€ä¿¡ä¸­...ğŸš€";

            const data = { userName: displayName, subject: selectedSubject, duration: finalDuration, score: score, goalMin: parseInt(document.getElementById('goal-input').value) || 0 };
            
            try {
                const r = await fetch(GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(data),
                    signal: AbortSignal.timeout(10000) // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                });
                const res = await r.json();
                
                if (res.status === 'success') {
                    localStorage.removeItem('study_startTime');
                    localStorage.removeItem('study_goalMin');
                    localStorage.removeItem('study_subject');
                    
                    if (liff.isInClient()) {
                        await liff.sendMessages([{ 'type': 'text', 'text': `ã€å­¦å¹´æœ«è€ƒæŸ»ã¸å‰é€²ï¼ã€‘\n${selectedSubject}ï¼š${min}åˆ†\n\næ­¦å†…AIã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼š\n${res.aiMsg || "ãƒŠã‚¤ã‚¹é›†ä¸­ï¼"}` }]);
                    }
                    liff.closeWindow();
                } else {
                    throw new Error('é€ä¿¡å¤±æ•—');
                }
            } catch (e) { 
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
                
                // LocalStorageã«æœªé€ä¿¡è¨˜éŒ²ã¨ã—ã¦ä¿å­˜
                const pending = JSON.parse(localStorage.getItem('pendingRecords') || '[]');
                pending.push({
                    ...data,
                    timestamp: new Date().toISOString(),
                    emoji: emoji
                });
                localStorage.setItem('pendingRecords', JSON.stringify(pending));
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                const retry = confirm("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nè¨˜éŒ²ã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚æ¬¡å›èµ·å‹•æ™‚ã«å†é€ä¿¡ã—ã¾ã™ã€‚\n\nä»Šã™ãå†è©¦è¡Œã—ã¾ã™ã‹ï¼Ÿ");
                
                if (retry) {
                    allBtns.forEach(b => b.style.pointerEvents = 'auto');
                    indicator.innerText = "å†è©¦è¡Œã—ã¦ãã ã•ã„";
                } else {
                    liff.closeWindow();
                }
            }
        }
        initTheme();
        initLiff();
    </script>
</body>
</html>