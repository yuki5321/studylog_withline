<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集中ログ - 武内AI</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f7f6; }
        .timer { font-size: 3.5rem; font-weight: bold; margin: 20px 0; }
        .subjects { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .subject-btn { padding: 10px; border: 1px solid #ddd; border-radius: 10px; background: white; font-size: 0.8rem; }
        .subject-btn.active { background: #00b900; color: white; }
        #main-btn { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 30px; border: none; background: #00b900; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <h2>学習記録</h2>
    <div id="user-name" style="font-size:0.8rem; color:#666;"></div>
    <div class="timer" id="timer-display">00:00</div>

    <div class="subjects" id="subject-list">
        <div class="subject-btn active" onclick="selectSubject('現代の国語')">現代の国語</div>
        <div class="subject-btn" onclick="selectSubject('数学Ⅰ')">数学Ⅰ</div>
        <div class="subject-btn" onclick="selectSubject('英語')">英語</div>
        </div>

    <button id="main-btn" onclick="toggleTimer()">START</button>

    <script>
        let startTime, timerInterval, isRunning = false, selectedSubject = '現代の国語', displayName = "User";
        const GAS_URL = "ここにあなたのGAS_URLを貼ってください";

        async function initLiff() {
            await liff.init({ liffId: "2009056355-TruGatly" });
            if (!liff.isLoggedIn()) { liff.login(); }
            const profile = await liff.getProfile();
            displayName = profile.displayName;
            document.getElementById('user-name').innerText = `こんにちは、${displayName}さん`;
        }

        function selectSubject(s) { if(!isRunning) { selectedSubject = s; document.querySelectorAll('.subject-btn').forEach(b => b.classList.toggle('active', b.innerText === s)); } }

        function toggleTimer() {
            const btn = document.getElementById('main-btn');
            if (!isRunning) {
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const sec = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('timer-display').innerText = `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
                }, 1000);
                btn.innerText = 'STOP'; btn.style.background = '#ff4b4b'; isRunning = true;
            } else {
                finishWithScore();
            }
        }

        async function finishWithScore() {
            clearInterval(timerInterval);
            const duration = Math.floor((Date.now() - startTime) / 1000);
            const min = Math.ceil(duration / 60);

            if (min < 5) { alert("5分以上頑張ろう！"); location.reload(); return; }

            document.getElementById('main-btn').innerText = "保存中...";
            document.getElementById('main-btn').disabled = true;

            try {
                const r = await fetch(GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'saveRecord', userName: displayName, subject: selectedSubject, duration: duration }) 
                });
                const res = await r.json();

                if (liff.isInClient()) {
                    // ここでAIコメントとランキングを一緒に送る
                    await liff.sendMessages([{
                        type: 'text',
                        text: `【学習完了報告】\n${selectedSubject}：${min}分\n\n武内AI：${res.aiMsg}${res.rankingMsg}`
                    }]);
                }
                liff.closeWindow();
            } catch (e) { alert("エラーが発生しました。"); }
        }
        initLiff();
    </script>
</body>
</html>