<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†ä¸­ãƒ­ã‚° - æ­¦å†…AI</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f7f6; color: #333; }
        h2 { margin-bottom: 5px; color: #00b900; }
        #user-name { font-size: 0.8rem; margin-bottom: 10px; color: #666; }
        #history-area { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; }
        #total-time { font-size: 1.6rem; font-weight: bold; color: #00b900; }
        .timer { font-size: 3.5rem; font-weight: bold; margin: 15px 0; font-family: monospace; }
        
        /* ç§‘ç›®ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .subjects { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .subject-btn { 
            padding: 8px 5px; border: 2px solid #ddd; border-radius: 10px; background: white; 
            font-size: 0.7rem; height: 65px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; line-height: 1.2; transition: 0.2s;
        }

        /* é¸æŠæ™‚ã®è‰²æŒ‡å®šï¼ˆä»¥å‰ã®è‰²åˆ†ã‘ã‚’å†ç¾ï¼‰ */
        .subject-btn[data-color="red"].active { background: #ff4b4b; color: white; border-color: #ff4b4b; }
        .subject-btn[data-color="blue"].active { background: #4b70ff; color: white; border-color: #4b70ff; }
        .subject-btn[data-color="green"].active { background: #00b900; color: white; border-color: #00b900; }
        .subject-btn[data-color="orange"].active { background: #ff9800; color: white; border-color: #ff9800; }
        .subject-btn[data-color="purple"].active { background: #9c27b0; color: white; border-color: #9c27b0; }
        .subject-btn[data-color="teal"].active { background: #009688; color: white; border-color: #009688; }

        #main-btn { width: 100%; padding: 18px; font-size: 1.3rem; border: none; border-radius: 50px; color: white; background: #00b900; font-weight: bold; cursor: pointer; }
        #main-btn.stop { background: #ff4b4b; }
        #feedback-area { background: white; padding: 20px; border-radius: 20px; display:none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #status-indicator { color: #00b900; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>å­¦ç¿’è¨˜éŒ²</h2>
    <div id="user-name">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="history-area">
        <div style="font-size: 0.7rem;">ç´¯è¨ˆå­¦ç¿’æ™‚é–“(5åˆ†ä»¥ä¸Š)</div>
        <div><span id="total-time">0</span> åˆ†</div>
    </div>

    <div class="timer" id="timer-display">00:00</div>

    <div id="subject-selector-ui">
        <div class="subjects">
            <div class="subject-btn active" data-color="red" onclick="selectSubject('ç¾ä»£ã®å›½èª')">ç¾ä»£ã®å›½èª</div>
            <div class="subject-btn" data-color="red" onclick="selectSubject('è¨€èªæ–‡åŒ–')">è¨€èªæ–‡åŒ–</div>
            <div class="subject-btn" data-color="blue" onclick="selectSubject('æ•°å­¦â… ')">æ•°å­¦â… </div>
            <div class="subject-btn" data-color="blue" onclick="selectSubject('æ•°å­¦A')">æ•°å­¦A</div>
            <div class="subject-btn" data-color="orange" onclick="selectSubject('è«–ç†è¡¨ç¾â… ')">è«–ç†è¡¨ç¾â… </div>
            <div class="subject-btn" data-color="orange" onclick="selectSubject('ECâ… ')">ECâ… </div>
            <div class="subject-btn" data-color="teal" onclick="selectSubject('ç‰©ç†åŸºç¤')">ç‰©ç†åŸºç¤</div>
            <div class="subject-btn" data-color="teal" onclick="selectSubject('åŒ–å­¦åŸºç¤')">åŒ–å­¦åŸºç¤</div>
            <div class="subject-btn" data-color="teal" onclick="selectSubject('ç”Ÿç‰©åŸºç¤')">ç”Ÿç‰©åŸºç¤</div>
            <div class="subject-btn" data-color="green" onclick="selectSubject('æ­´å²ç·åˆ')">æ­´å²ç·åˆ</div>
            <div class="subject-btn" data-color="purple" onclick="selectSubject('èŠ¸è¡“')">èŠ¸è¡“</div>
            <div class="subject-btn" data-color="purple" onclick="selectSubject('ä¿å¥')">ä¿å¥</div>
            <div class="subject-btn" data-color="blue" onclick="selectSubject('ã‚µã‚¤ã‚¨ãƒ³ã‚¹æƒ…å ±â… ')">æƒ…å ±â… </div>
        </div>
    </div>

    <div id="goal-setting" style="margin-bottom:15px;">
        <span style="font-size: 0.8rem;">ä»Šå›ã®ç›®æ¨™(åˆ†): </span>
        <input type="number" id="goal-input" value="0" min="0" style="width:50px; text-align:center;">
    </div>

    <div id="feedback-area">
        <p style="font-weight: bold;">é›†ä¸­ã§ããŸï¼Ÿ</p>
        <div class="subjects">
            <div class="subject-btn active" data-color="green" onclick="finishWithScore('ğŸ¤©', 3)">ğŸ¤© å®Œç’§</div>
            <div class="subject-btn active" data-color="orange" onclick="finishWithScore('ğŸ˜', 2)">ğŸ˜ æ™®é€š</div>
            <div class="subject-btn active" data-color="red" onclick="finishWithScore('ğŸ˜´', 1)">ğŸ˜´ çœ ã„</div>
        </div>
        <div id="status-indicator"></div>
    </div>

    <button id="main-btn" onclick="toggleTimer()">START</button>

    <script>
        let startTime, timerInterval, goalSeconds;
        let isRunning = false, isCountdown = false, finalDuration = 0;
        let selectedSubject = 'ç¾ä»£ã®å›½èª', displayName = "Unknown";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx0lGxxv5qfnCe0zTuoqYSE-Pat2dY8Bne8O_1SQ1Neie6kVoTqHoBXBuorVg1ZakM/exec";

        async function initLiff() {
            try {
                await liff.init({ liffId: "2009056355-TruGatly" }); 
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    displayName = profile.displayName; 
                    document.getElementById('user-name').innerText = `ã“ã‚“ã«ã¡ã¯ã€${displayName}ã•ã‚“`;
                    await loadHistory();
                    checkResumeTimer();
                }
            } catch (err) { console.error(err); }
        }

        function checkResumeTimer() {
            const savedStart = localStorage.getItem('study_startTime');
            if (savedStart) {
                startTime = parseInt(savedStart);
                const savedGoal = localStorage.getItem('study_goalMin') || 0;
                const savedSub = localStorage.getItem('study_subject');
                if (savedSub) selectSubject(savedSub);
                document.getElementById('goal-input').value = savedGoal;
                isCountdown = parseInt(savedGoal) > 0;
                goalSeconds = parseInt(savedGoal) * 60;
                isRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                const btn = document.getElementById('main-btn');
                btn.innerText = 'STOP'; btn.classList.add('stop');
                document.getElementById('goal-setting').style.display = 'none';
            }
        }

        async function loadHistory() {
            try {
                const r = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getHistory', userName: displayName }) });
                const res = await r.json();
                if (res.status === "success") document.getElementById('total-time').innerText = res.totalMinutes;
            } catch(e) { console.error(e); }
        }

        function selectSubject(s) { 
            if (!isRunning) { 
                selectedSubject = s; 
                document.querySelectorAll('.subject-btn').forEach(b => {
                    b.classList.toggle('active', b.innerText.includes(s));
                }); 
            } 
        }

        function toggleTimer() {
            if (!isRunning) {
                const gMin = parseInt(document.getElementById('goal-input').value) || 0;
                isCountdown = gMin > 0; goalSeconds = gMin * 60;
                startTime = Date.now(); 
                localStorage.setItem('study_startTime', startTime);
                localStorage.setItem('study_goalMin', gMin);
                localStorage.setItem('study_subject', selectedSubject);
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('main-btn').innerText = 'STOP';
                document.getElementById('main-btn').classList.add('stop');
                document.getElementById('goal-setting').style.display = 'none';
                isRunning = true;
            } else { stopTimer(); }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            let dSec = isCountdown ? Math.max(0, goalSeconds - elapsed) : elapsed;
            document.getElementById('timer-display').innerText = `${String(Math.floor(dSec / 60)).padStart(2, '0')}:${String(dSec % 60).padStart(2, '0')}`;
            if (isCountdown && dSec === 0) stopTimer();
        }

        function stopTimer() {
            clearInterval(timerInterval);
            finalDuration = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('main-btn').style.display = 'none';
            document.getElementById('subject-selector-ui').style.display = 'none';
            document.getElementById('feedback-area').style.display = 'block';
            isRunning = false;
        }

        async function finishWithScore(emoji, score) {
            const min = Math.ceil(finalDuration / 60);
            if (min < 5) alert("5åˆ†æœªæº€ã®è¨˜éŒ²ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚„åˆè¨ˆæ™‚é–“ã«ã¯åæ˜ ã•ã‚Œãªã„ã‚ˆï¼æ¬¡ã¯ã‚‚ã£ã¨é ‘å¼µã‚ã†ğŸ”¥");

            const allBtns = document.querySelectorAll('button, .subject-btn');
            allBtns.forEach(b => b.style.pointerEvents = 'none');
            const indicator = document.getElementById('status-indicator');
            indicator.innerText = "è¨˜éŒ²ã‚’ä¿å­˜ä¸­...ğŸš€";

            const data = { userName: displayName, subject: selectedSubject, duration: finalDuration, score: score, goalMin: parseInt(document.getElementById('goal-input').value) || 0 };
            
            try {
                const r = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) });
                const res = await r.json();
                localStorage.clear();
                if (liff.isInClient()) {
                    await liff.sendMessages([{ 
                        'type': 'text', 
                        'text': `ã€å­¦ç¿’è¨˜éŒ²ã€‘\n${selectedSubject}ï¼š${min}åˆ†\n\næ­¦å†…AIï¼š${res.aiMsg}${res.rankingMsg || ""}` 
                    }]);
                }
                liff.closeWindow();
            } catch (e) { 
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
                allBtns.forEach(b => b.style.pointerEvents = 'auto');
                indicator.innerText = "ã‚¨ãƒ©ãƒ¼ï¼šå†è©¦è¡Œã—ã¦ãã ã•ã„";
            }
        }
        initLiff();
    </script>
</body>
</html>